
/* Link GENERALLOAD
*/
SELECT SQL.TMPFILE
INTO :GEN FROM DUMMY;
LINK GENERALLOAD TO :GEN;
ERRMSG 1 WHERE :RETVAL = 0;

:LN = 0;
SELECT MAX(LINE) + 1 INTO :LN FROM GENERALLOAD;

/* insert Site line */
INSERT INTO GENERALLOAD (LINE , RECORDTYPE, KEY1)
SELECT DISTINCT :LN , '1' , ITOA(DOC)
FROM ZCLA_BUILDSTACK
WHERE USER = SQL.USER;

/* Declare and open plot cursor */
DECLARE PLOT_CURSOR CURSOR FOR
SELECT DISTINCT PLOT
, PROJACTS.PROJACT AS KEY1
FROM ZCLA_BUILDSTACK , PROJACTS ?
WHERE PLOT > 0
AND   PROJACTS.DOC = ZCLA_BUILDSTACK.DOC
AND   ATOI(PROJACTS.WBS) = ZCLA_BUILDSTACK.PLOT
AND   ZCLA_BUILDSTACK.USER = SQL.USER
AND   PROJACTS.LEVEL = 1
ORDER BY PLOT;

OPEN PLOT_CURSOR;
GOTO 9 WHERE :RETVAL = 0; /* Open failed; no record meets condition */

LABEL 1;
:PLOT = :KEY1 = 0;
FETCH PLOT_CURSOR INTO :PLOT, :KEY1;
GOTO 8 WHERE :RETVAL = 0; /* No more fetched records */

/* Create plot line */
SELECT MAX(LINE) + 1 INTO :LN FROM GENERALLOAD;

INSERT INTO GENERALLOAD (LINE , RECORDTYPE, KEY1, TEXT1, TEXT2 , INT3)
SELECT :LN
,    '2'
,    (PROJACTS.PROJACT = 0 ? '' : ITOA(PROJACTS.PROJACT)) AS KEY1
,    STRCAT('Plot ' , ITOA(:PLOT))
,    ITOA(:PLOT)
,    (ISHOUSE = 'Y' ? HOUSETYPE : 0) AS HOUSETYPE
FROM ZCLA_BUILDSTACK , PROJACTS ?
WHERE PLOT = :PLOT
AND   PROJACTS.DOC = ZCLA_BUILDSTACK.DOC
AND   ATOI(PROJACTS.WBS) = ZCLA_BUILDSTACK.PLOT
AND   ZCLA_BUILDSTACK.USER = SQL.USER
AND   PROJACTS.LEVEL = 1;

/* insert Element line */
:STATUS = 0;
SELECT MAX(LINE) INTO :LN FROM GENERALLOAD;
INSERT INTO GENERALLOAD (LINE , RECORDTYPE, INT1, INT2, INT3
, INT6 , INT7, TEXT2 , TEXT3 , TEXT1)
SELECT :LN + SQL.LINE
,   '3'
,   ZCLA_HOUSETYPE.EL
,   HOUSETYPEID
,   ZCLA_HOUSETYPE.COL
,   ALT
,   :STATUS
,   :STEPSTATUSDES
,   STYLE
,   GUID
FROM ZCLA_BUILDSTACK , ZCLA_HOUSETYPE
WHERE PLOT = :PLOT
AND   ZCLA_BUILDSTACK.HOUSETYPE = ZCLA_HOUSETYPE.HOUSETYPEID;


/* insert Element line */
SELECT MAX(LINE) INTO :LN FROM GENERALLOAD;
INSERT INTO GENERALLOAD (LINE , RECORDTYPE, INT1, INT2, INT3, INT6 , INT7, TEXT2 , TEXT3 , TEXT1)
SELECT :LN + SQL.LINE
,   '3'
,   ZCLA_HOUSETYPE.EL
,   HOUSETYPEID
,   ZCLA_HOUSETYPE.COL
,   ALT
,   ZCLA_ELSTATUSES.STEPSTATUS
,   ZCLA_ELSTATUSES.STEPSTATUSDES
,   STYLE
,   GUID
FROM ZCLA_BUILDSTACK , ZCLA_HOUSETYPE, ZCLA_ELSTATUSES, DOCSTATUSES
WHERE PLOT = :PLOT
AND   ZCLA_BUILDSTACK.HOUSETYPE = ZCLA_HOUSETYPE.HOUSETYPEID
AND   DOCSTATUSES.ORIGSTATUSID = ZCLA_ELSTATUSES.STEPSTATUS
AND   DOCSTATUSES.TYPE = 'ZCLA_EL'
AND   DOCSTATUSES.DOCOPENED = 'Y'
AND   EXISTS (
    SELECT 'x'
    FROM ZCLA_CONTRACTS , ZCLA_CONTRACTEL , ZCLA_CONTRACTSTATUSE, DOCSTATUSES , ZCLA_PLOTELEMENT
    WHERE 0=0
    AND   ZCLA_CONTRACTS.STEPSTATUS = ZCLA_CONTRACTSTATUSE.STEPSTATUS
    AND   ZCLA_CONTRACTS.CONTRACT = ZCLA_CONTRACTEL.CONTRACT
    AND   ZCLA_PLOTELEMENT.EL = ZCLA_CONTRACTEL.EL
    AND   DOCSTATUSES.ORIGSTATUSID = ZCLA_CONTRACTSTATUSE.STEPSTATUS
    AND   DOCSTATUSES.TYPE =  'ZCLA_CONT'
    AND   DOCSTATUSES.DOCOPENED = 'Y'
    AND   ZCLA_CONTRACTS.DOC =  :DOC
    AND   ZCLA_PLOTELEMENT.EL = :EL
);

LOOP 1;
LABEL 8;
CLOSE PLOT_CURSOR;
LABEL 9;

SELECT LINE 
,      RECORDTYPE
,      KEY1
,      TEXT1
,      TEXT2 
,      TEXT3
,      INT1 
,      INT2
,      INT3
,      INT6 
,      INT7
,      TEXT2 
FROM GENERALLOAD
FORMAT;

UNLINK AND REMOVE GENERALLOAD;