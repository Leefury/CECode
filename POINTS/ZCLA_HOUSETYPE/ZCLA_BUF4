INSERT INTO ZCLA_HOUSETYPEFIX
(HOUSETYPEID , FIXID)
SELECT :HOUSETYPE , FIXID
FROM ZCLA_FIXES
WHERE 0=0
AND   FIX <> '-1'
AND   FIXID > 0
;
UPDATE ZCLA_HOUSETYPEFIX
SET ZCLA_INITPOINTS = 0
,   ZCLA_TRAVEL = 0
,   ZCLA_MILEAGE = 0
WHERE 0=0
AND   HOUSETYPEID = :HOUSETYPE
;
/*
*/
:ZCLA_TIMETOSITE = :FIXID = 0 ;
:POINTS = :ZCLA_MILESTOSITE = :MILEAGE = :FULLPOINTS = :TRAVELCOST =
0.0 ;
/*
*/
SELECT ZCLA_MILESTOSITE , ZCLA_TIMETOSITE
INTO :ZCLA_MILESTOSITE , :ZCLA_TIMETOSITE
FROM DOCUMENTS
WHERE 0=0
AND   DOCUMENTS.DOC = :DOC
;
/*
*/
SELECT VALUE INTO :MILEAGE
FROM ZCLA_CONST
WHERE 0=0
AND   TYPE = 'TRAVEL'
AND   NAME = 'MILEAGE'
;
SELECT VALUE INTO :FULLPOINTS
FROM ZCLA_CONST
WHERE 0=0
AND   TYPE = 'TRAVEL'
AND   NAME = 'FULLPOINTS'
;
SELECT VALUE INTO :TRAVELCOST
FROM ZCLA_CONST
WHERE 0=0
AND   TYPE = 'TRAVEL'
AND   NAME = 'TRAVELCOST'
;
/*
*/
DECLARE @INIT CURSOR FOR
SELECT ZCLA_PARTPOINTSPF.FIXID
,      SUM ( ( ZCLA_PARTPOINTSPF.VALUE + (ZCLA_FIXES.FIX = '3' ?
ZCLA_ACCYCOL.POINTS : 0) ) * ZCLA_COMPONENT.TQUANT ) / 1000 AS
POINTS
FROM  ZCLA_ACCYCOL , ZCLA_PARTPOINTSPF , ZCLA_ROOMS , ZCLA_COMPONENT
, ZCLA_HOUSETYPE , ZCLA_FIXES
WHERE 0=0
AND   ZCLA_FIXES.FIXID = ZCLA_PARTPOINTSPF.FIXID
AND   ZCLA_ROOMS.ROOM = ZCLA_COMPONENT.ROOM
AND   ZCLA_ROOMS.HOUSETYPEID = ZCLA_HOUSETYPE.HOUSETYPEID
AND   ZCLA_PARTPOINTSPF.PART = ZCLA_COMPONENT.PART
AND   ZCLA_ACCYCOL.COL = ZCLA_COMPONENT.COL
AND   ZCLA_HOUSETYPE.HOUSETYPEID = :HOUSETYPE
GROUP BY ZCLA_PARTPOINTSPF.FIXID
;
OPEN @INIT ;
GOTO 999 WHERE :RETVAL = 0 ;
LABEL 500;
FETCH @INIT INTO :FIXID , :POINTS ;
GOTO 600 WHERE :RETVAL = 0;
/*
*/
:SUNDRYSUM = :PARTSUM = 0.0 ;
/*
*/
SELECT SUM(SONQUANT * PRICE) INTO :PARTSUM
FROM ZCLA_PARTARC , PRICELIST , PARTPRICE
WHERE 0=0
AND   ZCLA_PARTARC.USER = SQL.USER
AND   ZCLA_PARTARC.SON = PARTPRICE.PART
AND   PRICELIST.PLIST = PARTPRICE.PLIST
AND   PRICELIST.CURRENCY  = PARTPRICE.CURRENCY
AND   PRICELIST.PLIST = -1
AND   PARTPRICE.CURRENCY = -1
AND   QUANT = 1000
AND   ZCLA_PARTARC.ZCLA_FIXID = :FIXID
;
/*
*/
SELECT SUM(ZCLA_PARTARC.SONQUANT * PARTARC.SONQUANT *
PARTPRICE.PRICE) INTO :SUNDRYSUM
FROM  ZCLA_PARTARC ,  PARTARC ,  PARTPRICE ,  PRICELIST
WHERE 0=0
AND   ZCLA_PARTARC.SON = PARTARC.PART
AND   PARTARC.SON = PARTPRICE.PART
AND   PARTPRICE.PLIST = PRICELIST.PLIST
AND   ZCLA_PARTARC.USER = SQL.USER
AND   PRICELIST.CURRENCY  = PARTPRICE.CURRENCY
AND   PRICELIST.PLIST = -1
AND   PARTPRICE.CURRENCY = -1
AND   QUANT = 1000
AND   ZCLA_PARTARC.ZCLA_FIXID = :FIXID
;
/*
*/
UPDATE ZCLA_HOUSETYPEFIX
SET ZCLA_INITPOINTS = :POINTS
,   ZCLA_TRAVEL = ( ( (:ZCLA_TIMETOSITE * 2) * :TRAVELCOST) * (
:POINTS / :FULLPOINTS ) )
,   ZCLA_MILEAGE = ( ( (:ZCLA_MILESTOSITE * 2) * :MILEAGE ) * (
:POINTS / :FULLPOINTS ) )
,   ZCLA_PARTSUM = :PARTSUM
,   ZCLA_SUNDRY = :SUNDRYSUM
WHERE 0=0
AND   HOUSETYPEID = :HOUSETYPE
AND   FIXID = :FIXID
;
/*
*/
LOOP 500;
LABEL 600;
CLOSE @INIT ;
LABEL 999;
