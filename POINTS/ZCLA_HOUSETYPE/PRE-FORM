:ACTIVATE_POST_FORM = 'Y'
;
SELECT 'ZCLA_HOUSETYPE-PRE-FORM'
FROM DUMMY
FORMAT '../POINTS' ;
/*
*/
:FIXID = :HOUSETYPE = 0 ;
:CORE = '' ;
/*
*/
UPDATE ZCLA_HOUSETYPEFIX
SET ZCLA_FIXUPLIFT = 0
,   ZCLA_SITEUPLIFT = 0
,   ZCLA_BRUPLIFT = 0
,   ZCLA_NEGPOINT = 0
,   ZCLA_UPLIFT = 0
,   MOD_ST = 0
,   ZCLA_LABOURPOINTS = 0
,   ZCLA_LABTOTAL = 0
WHERE 0=0
AND   HOUSETYPEID = :HOUSETYPE
;
/*
*/
DECLARE @C CURSOR FOR
SELECT ZCLA_HOUSETYPE.HOUSETYPEID , FIXID , CORE
FROM ZCLA_HOUSETYPE , ZCLA_HOUSETYPEFIX 
WHERE 0=0
AND   ZCLA_HOUSETYPE.HOUSETYPEID = ZCLA_HOUSETYPEFIX.HOUSETYPEID
AND  ZCLA_HOUSETYPE.DOC = 0 + :$$.DOC ;
OPEN @C ;
GOTO 9 WHERE :RETVAL = 0 ;
LABEL 1;
FETCH @C INTO :HOUSETYPE , :FIXID , :CORE;
GOTO 8 WHERE :RETVAL = 0;
/*
*/
INSERT INTO ZCLA_HOUSETYPEFIX
(HOUSETYPEID , FIXID)
SELECT :HOUSETYPE , FIXID
FROM ZCLA_FIXES
WHERE 0=0
AND   FIX <> '-1'
AND   FIXID > 0
;
/*
*/
:SAFETYMARGIN = :POINTVALUE = 0.0 ;
SELECT VALUE INTO :SAFETYMARGIN
FROM ZCLA_CONST
WHERE 0=0
AND   TYPE = 'FIN'
AND   NAME = 'SAFETYMARGIN'
;
SELECT CASHVALUE INTO :POINTVALUE
FROM ZCLA_FIXES
WHERE 0=0
AND   FIXID = :FIX
;
/*
*/
:NEGPOINT = :BRUPLIFT = :SITEUPLIFT = :FIXUPLIFT = 0.0 ;
SELECT FIXUPLIFT INTO :FIXUPLIFT
FROM ZCLA_FIXES
WHERE FIXID = :FIXID
;
SELECT POINTS INTO :BRUPLIFT
FROM ZCLA_BRANCHFIX
WHERE 0=0
AND   BRANCH = :$$.ZCLA_BRANCH
AND   FIXID = :FIXID
;
GOTO 1999 WHERE :CORE = 'Y' ;
:SITEUPLIFT = 0.0 ;
SELECT UPLIFT INTO :SITEUPLIFT
FROM ZCLA_PROJBRANCHFIX
WHERE 0=0
AND   FIXID = :FIXID
AND   PROJ = :$$.DOC
;
SELECT FIXUPLIFT INTO :NEGPOINT
FROM ZCLA_PROJNEGFIX
WHERE 0=0
AND    ZCLA_PROJNEGFIX.PROJ = :$$.DOC
AND    ZCLA_PROJNEGFIX.FIX = :FIX
;
LABEL 1999 ;
/*
*/
:IMOD_ST = 0.0 ;
SELECT MOD_ST INTO :IMOD_ST 
FROM ZCLA_SITEFIX 
WHERE 0=0
AND   ZCLA_SITEFIX.FIXID = :FIXID
AND   ZCLA_SITEFIX.DOC = :$$.DOC
;
:ZCLA_UPLIFT = :INTPOINTS = :MOD_HT = 0.0 ;
SELECT ZCLA_INITPOINTS , MOD_HT
INTO :INTPOINTS , :MOD_HT
FROM ZCLA_HOUSETYPEFIX 
WHERE 0=0
AND   HOUSETYPEID = :HOUSETYPE
AND   FIXID = :FIXID
;
SELECT  1 + ((:BRUPLIFT + :FIXUPLIFT + :SITEUPLIFT) / 100 ) INTO :ZCLA_UPLIFT
FROM DUMMY;
SELECT :INTPOINTS , :ZCLA_UPLIFT , :IMOD_ST , :MOD_HT
FROM DUMMY
FORMAT ADDTO '../POINTS'
;
SELECT :INTPOINTS * :ZCLA_UPLIFT
INTO :INTPOINTS FROM DUMMY ;
SELECT :INTPOINTS * :IMOD_ST
INTO :INTPOINTS FROM DUMMY ;
SELECT :INTPOINTS * :MOD_HT
INTO :INTPOINTS FROM DUMMY ;
/*
*/
UPDATE ZCLA_HOUSETYPEFIX
SET ZCLA_FIXUPLIFT = :FIXUPLIFT
,   ZCLA_SITEUPLIFT = :SITEUPLIFT
,   ZCLA_BRUPLIFT = :BRUPLIFT 
,   ZCLA_UPLIFT =  :ZCLA_UPLIFT
,   ZCLA_NEGPOINT = :NEGPOINT 
,   MOD_ST = :IMOD_ST 
,   ZCLA_LABOURPOINTS = :INTPOINTS
,   ZCLA_LABTOTAL = :INTPOINTS * :POINTVALUE
WHERE 0=0
AND   HOUSETYPEID = :HOUSETYPE
AND   FIXID = :FIXID
;
/*
*/
LOOP 1;
LABEL 8;
CLOSE @C ;
LABEL 9;
