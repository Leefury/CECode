:WHT = :DEBUG = 0 ;
SELECT COL INTO :WHT
FROM ZCLA_ACCYCOL
WHERE NAME = 'White'
;
:HOUSETYPEID = :ROOM = :PART = :SON = :COL = :FAMILY = 0 ;
:ZCLA_WHITE = '' ;
/* Clear missing flag
*/
DECLARE @E99 CURSOR FOR
SELECT  ZCLA_HOUSETYPE.HOUSETYPEID
,   ZCLA_COMPONENT.ROOM
,   ZCLA_COMPONENT.PART
FROM   ZCLA_COMPONENT  , ZCLA_HOUSETYPE , ZCLA_ROOMS , PART
WHERE  0=0
AND   ZCLA_HOUSETYPE.HOUSETYPEID = ZCLA_ROOMS.HOUSETYPEID
AND   ZCLA_COMPONENT.ROOM = ZCLA_ROOMS.ROOM
AND   PART.PART = ZCLA_COMPONENT.PART
AND    (ZCLA_HOUSETYPE.HOUSETYPEID = :$$.HOUSETYPEID)
;
OPEN @E99;
GOTO 203239 WHERE :RETVAL = 0;
LABEL 203231 ;
FETCH @E99 INTO :HOUSETYPEID , :ROOM , :PART
;
GOTO 203238 WHERE :RETVAL = 0
;
UPDATE ZCLA_HOUSETYPE SET ZCLA_MISSINGREPL = ''
WHERE HOUSETYPEID = :HOUSETYPEID ;
UPDATE ZCLA_ROOMS SET ZCLA_MISSINGREPL = ''
WHERE ROOM = :ROOM ;
UPDATE ZCLA_COMPONENT SET ZCLA_MISSINGREPL = ''
WHERE 0=0
AND   PART = :PART
AND   ROOM = :ROOM
;
LOOP 203231 ;
LABEL 203238 ;
CLOSE @E99;
LABEL 203239 ;
/* Check for missing replacement parts
*/
DECLARE @E98 CURSOR FOR
SELECT  ZCLA_HOUSETYPE.HOUSETYPEID
,   ZCLA_COMPONENT.ROOM
,   ZCLA_COMPONENT.PART
,   PARTARC.SON
,   PARTARC.ZCLA_WHITE
,   ZCLA_COMPONENT.COL
,   PART.FAMILY
FROM   PARTARC , ZCLA_COMPONENT  , ZCLA_HOUSETYPE , ZCLA_ROOMS ,
PART
WHERE  0=0
AND   ZCLA_HOUSETYPE.HOUSETYPEID = ZCLA_ROOMS.HOUSETYPEID
AND   ZCLA_COMPONENT.ROOM = ZCLA_ROOMS.ROOM
AND   PARTARC.PART = ZCLA_COMPONENT.PART
AND   PART.PART = ZCLA_COMPONENT.PART
AND    (ZCLA_HOUSETYPE.HOUSETYPEID = :$$.HOUSETYPEID)
AND    PARTARC.SON IN
(SELECT        PART
FROM            ZCLA_GENERICMANF)
;
OPEN @E98;
GOTO 1203239 WHERE :RETVAL = 0;
LABEL 1203231;
FETCH @E98 INTO :HOUSETYPEID
,   :ROOM
,   :PART
,   :SON
,   :ZCLA_WHITE
,   :COL
,   :FAMILY
;
GOTO 1203238 WHERE :RETVAL = 0
;
:MANFID = 0 ;
/* select manufacturer from default or site
*/
SELECT :$$$.TYPE
FROM DUMMY
WHERE :DEBUG = 1
FORMAT ADDTO '../ZCLA_ROOMS-PRE-FORM2'
;
GOTO 300 WHERE :$$$.TYPE <> 'Â¬';
/* from default */
:PCUST = 0 ;
SELECT PCUST INTO :PCUST
FROM CUSTOMERS
WHERE CUST = :$$$.CUST
;
SELECT :$$$.TYPE , :$$$.CUST , :PCUST
FROM DUMMY
WHERE :DEBUG = 1
FORMAT ADDTO '../ZCLA_ROOMS-PRE-FORM2'
;
SELECT MANFID INTO :MANFID
FROM ZCLA_DEFAULTMANF
WHERE 0=0
AND   CUST = :PCUST
AND   ZCLA_DEFAULTMANF.FAMILY = :FAMILY
AND   COL = ( :ZCLA_WHITE <> 'Y' ? :COL : :WHT)
;
GOTO 400 ;
LABEL 300 ;
/* from site */
SELECT MANFID INTO :MANFID
FROM ZCLA_PROJMANF
WHERE 0=0
AND   DOC = :$$$.DOC
AND   ZCLA_PROJMANF.FAMILY = :FAMILY
AND   COL = ( :ZCLA_WHITE <> 'Y' ? :COL : :WHT)
;
LABEL 400 ;
/*
*/
SELECT :HOUSETYPEID
,   :ROOM
,   :PART
,   :SON
,   :ZCLA_WHITE
,   :COL
,   :FAMILY
,   :MANFID
FROM DUMMY
WHERE :DEBUG = 1
FORMAT ADDTO '../ZCLA_ROOMS-PRE-FORM2'
;
LOOP 1203231 WHERE EXISTS (
SELECT 'x'
FROM ZCLA_GENERICMANF , PART
WHERE 0=0
AND   ZCLA_GENERICMANF.REPLPART = PART.PART
AND   PART.FAMILY = :FAMILY
AND   MNF = :MANFID
AND   ZCLA_GENERICMANF.PART = :SON
AND   COL = ( :ZCLA_WHITE <> 'Y' ? :COL : :WHT )
);
/* Set missing flag
*/
UPDATE ZCLA_HOUSETYPE SET ZCLA_MISSINGREPL = 'Y'
WHERE HOUSETYPEID = :HOUSETYPEID
;
UPDATE ZCLA_ROOMS SET ZCLA_MISSINGREPL = 'Y'
WHERE ROOM = :ROOM
;
UPDATE ZCLA_COMPONENT SET ZCLA_MISSINGREPL = 'Y'
WHERE 0=0
AND   ROOM = :ROOM
AND   PART = :PART
;
LOOP 1203231 ;
LABEL 1203238 ;
CLOSE @E98 ;
LABEL 1203239;
